<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Night Shift</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; touch-action: none; }
        #overlay { position: absolute; width: 100%; height: 100%; background: black; color: #0f0; 
                   display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; }
        #ui { position: absolute; top: 20px; left: 20px; color: #fff; z-index: 50; background: rgba(0,0,0,0.5); padding: 10px; border: 1px solid #fff; }
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border: 2px solid #fff; border-radius: 50%; z-index: 50; }
        #knob { position: absolute; width: 30px; height: 30px; background: #fff; border-radius: 50%; left: 25px; top: 25px; }
        button { padding: 15px 30px; background: #040; color: #0f0; border: 1px solid #0f0; cursor: pointer; font-family: inherit; }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>NIGHT SHIFT: STORE #104</h1>
        <p>COMPLETE YOUR TASKS. DO NOT LEAVE.<br>THE MANAGER IS WATCHING.</p>
        <button onclick="start()">START SHIFT</button>
    </div>
    
    <div id="ui">TASK: <span id="taskText">MOP THE SPILL (Back Left)</span></div>
    <div id="joystick"><div id="knob"></div></div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        let scene, camera, renderer, monster, clock, pointLight;
        let moveX = 0, moveZ = 0;
        let gameActive = false;
        let taskPhase = 0;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
            camera.position.set(0, 1.6, 4);
            scene.add(camera);

            // Store Lighting (Dim & Cold)
            pointLight = new THREE.PointLight(0xffffff, 5, 15);
            pointLight.position.set(0, 3, 0);
            scene.add(pointLight);

            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Store Walls & Floor
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x555555 });
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(10, 10), new THREE.MeshStandardMaterial({ color: 0x222222 }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Shelves (Simple Blocks)
            const shelfGeo = new THREE.BoxGeometry(1, 2, 4);
            const shelf1 = new THREE.Mesh(shelfGeo, wallMat);
            shelf1.position.set(-2, 1, 0);
            scene.add(shelf1);

            const shelf2 = shelf1.clone();
            shelf2.position.x = 2;
            scene.add(shelf2);

            // THE CUSTOMER (The Monster)
            const monsterGeo = new THREE.BoxGeometry(0.6, 2, 0.6);
            const monsterMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
            monster = new THREE.Mesh(monsterGeo, monsterMat);
            monster.position.set(0, 1, -8); // Starts outside in the dark
            scene.add(monster);

            // Task Goal Marker
            const goalGeo = new THREE.SphereGeometry(0.3);
            const goalMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
            const goal = new THREE.Mesh(goalGeo, goalMat);
            goal.name = "goal";
            goal.position.set(-3.5, 0.3, -3.5);
            scene.add(goal);

            setupControls();
            animate();
        }

        function setupControls() {
            const joy = document.getElementById('joystick');
            const knob = document.getElementById('knob');
            const handleMove = (e) => {
                const t = e.touches[0];
                const rect = joy.getBoundingClientRect();
                moveX = (t.clientX - rect.left - 40) / 40;
                moveZ = (t.clientY - rect.top - 40) / 40;
                knob.style.transform = `translate(${moveX*20}px, ${moveZ*20}px)`;
            };
            joy.addEventListener('touchmove', handleMove);
            joy.addEventListener('touchend', () => { moveX = 0; moveZ = 0; knob.style.transform = 'translate(0,0)'; });
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!gameActive) return;

            // Player Movement
            camera.position.z += moveZ * 0.08;
            camera.position.x += moveX * 0.08;
            camera.rotation.y -= moveX * 0.04;

            // Task Logic
            const goal = scene.getObjectByName("goal");
            if(camera.position.distanceTo(goal.position) < 1.5) {
                completeTask();
            }

            // Monster Logic: Creeps up when you are far from it
            const dist = camera.position.distanceTo(monster.position);
            if(dist > 3) monster.position.z += 0.015;

            // Flickering light
            if(Math.random() > 0.98) pointLight.intensity = Math.random() * 5;

            if(dist < 1) {
                gameActive = false;
